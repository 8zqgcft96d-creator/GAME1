<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>雙關卡遊戲：修正版</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        body { 
            margin: 0; padding: 0; background-color: #000; 
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center; 
            color: white; font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>

<script>
    // ===========================================
    // 2. 類別定義 (必須放在設定之前)
    // ===========================================

    // 第一關卡：射擊遊戲 (Level1)
    class Level1 extends Phaser.Scene {
        constructor() {
            super('Level1');
            this.player; this.cursors; this.bullets; this.enemies;
            this.score = 0; this.lives = 5; this.timeLeft = 60;
            this.scoreText; this.livesText; this.timeText;
            this.centerText; this.subText;
            this.isGameRunning = false;
            this.enemyTimer; this.gameClock;
        }
        // ... (省略 Level1 的 preload, create, update, 及其它函式內容，保持與上次提供的一致)
        // ... 為了簡潔，這裡省略了所有函數的實現，但您應保持完整
        
        // ---------------- 必須完整的函式 ----------------
        preload() {
            this.load.image('sky', 'https://labs.phaser.io/assets/skies/space3.png');
            this.load.image('player', 'https://labs.phaser.io/assets/sprites/phaser-dude.png');
            this.load.image('bullet', 'https://labs.phaser.io/assets/sprites/bullets/bullet5.png'); 
            this.load.image('enemy', 'https://labs.phaser.io/assets/sprites/space-baddie.png');
        }

        create() {
            this.add.image(400, 300, 'sky');
            this.scoreText = this.add.text(16, 16, '分數: 0', { fontSize: '24px', fill: '#FFF' });
            this.livesText = this.add.text(350, 16, '生命: 5', { fontSize: '24px', fill: '#00FF00' });
            this.timeText  = this.add.text(650, 16, '時間: 60', { fontSize: '24px', fill: '#FFFF00' });

            this.centerText = this.add.text(400, 250, '太空射擊挑戰', { fontSize: '48px', fill: '#00FFFF' }).setOrigin(0.5);
            this.subText = this.add.text(400, 320, '按 [ENTER] 開始遊戲', { fontSize: '24px', fill: '#FFF' }).setOrigin(0.5);

            this.player = this.physics.add.sprite(400, 500, 'player').setScale(1.5);
            this.player.setCollideWorldBounds(true);
            this.player.setVisible(false);
            this.player.setActive(false);

            this.bullets = this.physics.add.group();
            this.enemies = this.physics.add.group();

            this.cursors = this.input.keyboard.createCursorKeys();
            this.input.keyboard.on('keydown-SPACE', this.fireBullet, this);
            
            this.input.keyboard.on('keydown-ENTER', () => {
                if (!this.isGameRunning || this.lives <= 0 || this.timeLeft <= 0) {
                     this.startGame();
                }
            });

            this.physics.add.overlap(this.bullets, this.enemies, this.hitEnemy, null, this);
            this.physics.add.overlap(this.player, this.enemies, this.hitPlayer, null, this);
        }

        update() {
            if (!this.isGameRunning) return;

            if (this.cursors.left.isDown) {
                this.player.setVelocityX(-300);
            } else if (this.cursors.right.isDown) {
                this.player.setVelocityX(300);
            } else {
                this.player.setVelocityX(0);
            }

            this.bullets.children.each(function(b) {
                if (b.active && b.y < -10) b.destroy();
            });

            this.enemies.children.each(function(e) {
                if (e.active) {
                    e.y += 3;
                    if (e.y > 620) e.destroy();
                }
            }, this);
        }

        startGame() {
            this.score = 0;
            this.lives = 5;
            this.timeLeft = 60;
            this.isGameRunning = true;

            this.scoreText.setText('分數: ' + this.score);
            this.livesText.setText('生命: ' + this.lives);
            this.timeText.setText('時間: ' + this.timeLeft);
            
            this.centerText.setVisible(false);
            this.subText.setVisible(false);
            this.player.setVisible(true);
            this.player.setActive(true);
            this.player.setPosition(400, 500);
            this.player.clearTint();

            this.enemies.clear(true, true);

            if (this.enemyTimer) this.enemyTimer.remove();
            this.enemyTimer = this.time.addEvent({
                delay: 800,
                callback: this.spawnEnemy,
                callbackScope: this,
                loop: true
            });

            if (this.gameClock) this.gameClock.remove();
            this.gameClock = this.time.addEvent({
                delay: 1000,
                callback: this.onSecondPassed,
                callbackScope: this,
                loop: true
            });
        }

        spawnEnemy() {
            if (!this.isGameRunning) return;
            const x = Phaser.Math.Between(50, 750);
            const enemy = this.enemies.create(x, -50, 'enemy').setScale(1.5);
            enemy.setVelocityY(150);
        }

        fireBullet() {
            if (!this.isGameRunning || !this.player.active) return;
            let bullet = this.bullets.create(this.player.x, this.player.y - 30, 'bullet').setScale(1.5);
            if (bullet) {
                bullet.setVelocityY(-400);
            }
        }

        hitEnemy(bullet, enemy) {
            bullet.destroy();
            enemy.destroy();
            this.score += 10;
            this.scoreText.setText('分數: ' + this.score);
        }

        hitPlayer(player, enemy) {
            enemy.destroy();
            this.lives--;
            this.livesText.setText('生命: ' + this.lives);
            
            this.cameras.main.shake(200, 0.01);
            player.setTint(0xff0000);
            this.time.delayedCall(200, () => player.clearTint());

            if (this.lives <= 0) {
                this.endGame(false);
            }
        }

        onSecondPassed() {
            this.timeLeft--;
            this.timeText.setText('時間: ' + this.timeLeft);

            if (this.timeLeft <= 0) {
                this.endGame(true);
            }
        }

        endGame(isWin) {
            this.isGameRunning = false;
            this.player.setActive(false);
            this.player.setVelocity(0);
            this.player.setVisible(false);

            if (this.enemyTimer) this.enemyTimer.remove();
            if (this.gameClock) this.gameClock.remove();

            this.centerText.setVisible(true);
            this.subText.setVisible(true);

            if (isWin) {
                this.centerText.setText('關卡1 完成！');
                this.centerText.setColor('#00FF00');
                this.subText.setText('準備進入下一關...\n(自動跳轉)');
                this.time.delayedCall(3000, () => {
                    this.scene.start('Level2'); // 跳轉到 Level2
                }, [], this);
            } else {
                this.centerText.setText('遊戲結束');
                this.centerText.setColor('#FF0000');
                this.subText.setText('最終分數: ' + this.score + '\n按 [ENTER] 再玩一次');
            }
        }
    }

    // 第二關卡：平台跳躍遊戲 (Level2)
    class Level2 extends Phaser.Scene {
        constructor() {
            super('Level2');
            this.player2; this.platforms; this.cursors2;
            this.gameOver2 = false; this.finishFlag;
            this.centerText2; this.subText2;
        }

        preload() {
            this.load.image('sky2', 'https://labs.phaser.io/assets/skies/space3.png');
            this.load.image('ground', 'https://labs.phaser.io/assets/platform.png');
            this.load.image('star', 'https://labs.phaser.io/assets/star.png');
            this.load.spritesheet('dude', 
                'https://labs.phaser.io/assets/sprites/dude.png',
                { frameWidth: 32, frameHeight: 48 }
            );
        }

        create() {
            this.physics.world.gravity.y = 300; // 設置重力

            this.add.image(400, 300, 'sky2');
            this.platforms = this.physics.add.staticGroup();
            this.platforms.create(400, 568, 'ground').setScale(2).refreshBody();
            this.platforms.create(600, 400, 'ground');
            this.platforms.create(50, 250, 'ground');
            this.platforms.create(750, 220, 'ground');

            this.player2 = this.physics.add.sprite(100, 450, 'dude').setScale(1.2);
            this.player2.setBounce(0.2);
            this.player2.setCollideWorldBounds(true);

            this.anims.create({ key: 'left', frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 3 }), frameRate: 10, repeat: -1 });
            this.anims.create({ key: 'turn', frames: [ { key: 'dude', frame: 4 } ], frameRate: 20 });
            this.anims.create({ key: 'right', frames: this.anims.generateFrameNumbers('dude', { start: 5, end: 8 }), frameRate: 10, repeat: -1 });

            this.physics.add.collider(this.player2, this.platforms);

            this.finishFlag = this.physics.add.sprite(750, 100, 'star').setScale(2);
            this.finishFlag.setImmovable(true);
            this.physics.add.collider(this.finishFlag, this.platforms);

            this.physics.add.overlap(this.player2, this.finishFlag, this.reachFlag, null, this);

            this.cursors2 = this.input.keyboard.createCursorKeys();

            this.centerText2 = this.add.text(400, 250, '', { fontSize: '48px', fill: '#FF00FF' }).setOrigin(0.5);
            this.subText2 = this.add.text(400, 320, '', { fontSize: '24px', fill: '#FFF' }).setOrigin(0.5);

            this.input.keyboard.on('keydown-R', () => {
                if (this.gameOver2) {
                    this.scene.start('Level1'); // 讓它回到第一關，而不是只重啟第二關
                }
            });
        }

        update() {
            if (this.gameOver2) return;

            if (this.cursors2.left.isDown) {
                this.player2.setVelocityX(-160);
                this.player2.anims.play('left', true);
            } else if (this.cursors2.right.isDown) {
                this.player2.setVelocityX(160);
                this.player2.anims.play('right', true);
            } else {
                this.player2.setVelocityX(0);
                this.player2.anims.play('turn');
            }

            if (this.cursors2.up.isDown && this.player2.body.touching.down) {
                this.player2.setVelocityY(-330);
            }
        }

        reachFlag(player, flag) {
            this.gameOver2 = true;
            this.physics.pause();
            player.setTint(0x00FF00);
            this.centerText2.setText('所有關卡完成！');
            this.centerText2.setColor('#00FF00');
            this.subText2.setText('恭喜您！\n按 [R] 重新開始遊戲');
        }
    }

    // ------------------------------------------
    // 3. 遊戲設定與啟動 (最後執行)
    // ------------------------------------------
    const config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        scale: {
            mode: Phaser.Scale.FIT, 
            autoCenter: Phaser.Scale.CENTER_BOTH,
            parent: 'phaser-example',
        },
        physics: {
            default: 'arcade',
            arcade: { gravity: { y: 0 }, debug: false }
        },
        // 確保引用的是類別名稱 Level1 和 Level2
        scene: [ Level1, Level2 ] 
    };

    const game = new Phaser.Game(config);
</script>

</body>
</html>
